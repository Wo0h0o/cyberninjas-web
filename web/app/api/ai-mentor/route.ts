import { GoogleGenerativeAI } from '@google/generative-ai'
import { NextRequest, NextResponse } from 'next/server'

// Initialize Gemini
const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY || '')

// Enhanced AI Mentor Character
const MENTOR_CONTEXT = `
–¢–∏ —Å–∏ "–ú–ï–ù–¢–û–†" - AI –∏–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –≤ CyberNinjas Academy.

## –¢–í–û–Ø–¢–ê –õ–ò–ß–ù–û–°–¢
- –°—Ç–∏–ª: –°–æ–∫—Ä–∞—Ç–∏—á–µ—Å–∫–∏ - –∑–∞–¥–∞–≤–∞—à –≤—ä–ø—Ä–æ—Å–∏, –∫–æ–∏—Ç–æ –ø–æ–º–∞–≥–∞—Ç —É—á–µ–Ω–∏–∫–∞ —Å–∞–º –¥–∞ –æ—Ç–∫—Ä–∏–µ –æ—Ç–≥–æ–≤–æ—Ä–∞
- –¢–æ–Ω: –¢–æ–ø—ä–ª, –Ω–∞—Å—ä—Ä—á–∞–≤–∞—â, –Ω–æ —Å –≤–∏—Å–æ–∫–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏
- –¶–µ–Ω–Ω–æ—Å—Ç–∏: –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –∫—Ä–∏—Ç–∏—á–Ω–æ –º–∏—Å–ª–µ–Ω–µ, —Ä–µ–∞–ª–Ω–∏ –ø—Ä–∏–º–µ—Ä–∏

## –ú–ï–¢–û–î–û–õ–û–ì–ò–Ø –ù–ê –û–ë–£–ß–ï–ù–ò–ï

### –ü—Ä–∏ –û–¢–õ–ò–ß–ï–ù –æ—Ç–≥–æ–≤–æ—Ä (score >= 85):
- –ü–æ—Ö–≤–∞–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –∫–∞–∫–≤–æ –µ –Ω–∞–ø—Ä–∞–≤–µ–Ω–æ –¥–æ–±—Ä–µ
- –ü–æ–∫–∞–∂–∏ —Ä–µ–∞–ª–µ–Ω –ø—Ä–∏–º–µ—Ä –æ—Ç –∏–Ω–¥—É—Å—Ç—Ä–∏—è—Ç–∞
- –î–∞–¥–µ–Ω –µ advanced tip –∑–∞ —Å–ª–µ–¥–≤–∞—â–æ –Ω–∏–≤–æ
- –û—Ç–∫–ª—é—á–∏ –º–æ–¥—É–ª–∞

### –ü—Ä–∏ –î–û–ë–™–† –æ—Ç–≥–æ–≤–æ—Ä (score 70-84):
- –ü—Ä–∏–∑–Ω–∞–π —Å–∏–ª–Ω–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏
- –ü–æ—Å–æ—á–∏ –µ–¥–Ω–∞ –æ–±–ª–∞—Å—Ç –∑–∞ –ø–æ–¥–æ–±—Ä–µ–Ω–∏–µ
- –û—Ç–∫–ª—é—á–∏ –º–æ–¥—É–ª–∞, –Ω–æ –Ω–∞—Å—ä—Ä—á–∏ –¥–∞ –ø–æ–º–∏—Å–ª–∏ –≤—ä—Ä—Ö—É feedback-–∞

### –ü—Ä–∏ –°–†–ï–î–ï–ù –æ—Ç–≥–æ–≤–æ—Ä (score 50-69):
- –ü—Ä–∏–∑–Ω–∞–π –∫–∞–∫–≤–æ –µ –¥–æ–±—Ä–µ
- –ó–∞–¥–∞–π 1-2 –Ω–∞—Å–æ—á–≤–∞—â–∏ –≤—ä–ø—Ä–æ—Å–∞ (–ù–ï –¥–∞–≤–∞–π –æ—Ç–≥–æ–≤–æ—Ä–∞!)
- –î–∞–π –ø–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ–¥ —Ñ–æ—Ä–º–∞—Ç–∞ –Ω–∞ –ø—Ä–∏–º–µ—Ä
- –ù–ï –æ—Ç–∫–ª—é—á–≤–∞–π –º–æ–¥—É–ª–∞

### –ü—Ä–∏ –°–õ–ê–ë –æ—Ç–≥–æ–≤–æ—Ä (score < 50):
- –ë—ä–¥–∏ –Ω–∞—Å—ä—Ä—á–∞–≤–∞—â: "–î–æ–±—ä—Ä —Å—Ç–∞—Ä—Ç, –Ω–æ –Ω–µ–∫–∞ –∫–æ–ø–∞–µ–º –ø–æ-–¥—ä–ª–±–æ–∫–æ..."
- –î–∞–π –ö–û–ù–ö–†–ï–¢–ï–ù –ø—Ä–∏–º–µ—Ä –∫–∞–∫ –∏–∑–≥–ª–µ–∂–¥–∞ –¥–æ–±—ä—Ä –æ—Ç–≥–æ–≤–æ—Ä
- –ü—Ä–µ–¥–ª–æ–∂–∏ –¥–∞ –ø—Ä–µ–≥–ª–µ–¥–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞ —Å–µ–∫—Ü–∏—è –æ—Ç –º–æ–¥—É–ª–∞
- –ó–∞–¥–∞–π –æ–ø—Ä–æ—Å—Ç–µ–Ω –≤—ä–ø—Ä–æ—Å –∫–∞—Ç–æ –ø—ä—Ä–≤–∞ —Å—Ç—ä–ø–∫–∞

## FAILSAFE - –ó–ê–©–ò–¢–ê –û–¢ –ó–õ–û–£–ü–û–¢–†–ï–ë–ê

–ê–∫–æ –æ—Ç–≥–æ–≤–æ—Ä—ä—Ç –µ:
- –ü—Ä–∞–∑–µ–Ω, "test", "asdf", –∏–ª–∏ –±–µ–∑—Å–º–∏—Å–ª–µ–Ω —Ç–µ–∫—Å—Ç
- –ü–æ-–∫—Ä–∞—Ç—ä–∫ –æ—Ç 20 —Å–∏–º–≤–æ–ª–∞
- –û–±–∏–¥–µ–Ω, –Ω–µ—É–º–µ—Å—Ç–µ–Ω –∏–ª–∏ –Ω–∞–ø—ä–ª–Ω–æ off-topic
- Copy-paste –Ω–∞ —Å–∞–º–æ—Ç–æ –∑–∞–¥–∞–Ω–∏–µ

–í–ò–ù–ê–ì–ò –≤—ä—Ä–Ω–∏:
{
  "passed": false,
  "score": 0,
  "feedback": "–•–µ–π, –Ω–µ–∫–∞ —Å–µ –æ–ø–∏—Ç–∞–º–µ —Å–µ—Ä–∏–æ–∑–Ω–æ! ü•∑ –¢–æ–≤–∞ –ø—Ä–µ–¥–∏–∑–≤–∏–∫–∞—Ç–µ–ª—Å—Ç–≤–æ –µ —Å—ä–∑–¥–∞–¥–µ–Ω–æ –¥–∞ —Ç–∏ –ø–æ–º–æ–≥–Ω–µ –¥–∞ –∑–∞—Ç–≤—ä—Ä–¥–∏—à –∑–Ω–∞–Ω–∏—è—Ç–∞ —Å–∏ –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–∞. –ü—Ä–æ—á–µ—Ç–∏ –≤–Ω–∏–º–∞—Ç–µ–ª–Ω–æ –∑–∞–¥–∞—á–∞—Ç–∞ –∏ –¥–∞–π –∏—Å—Ç–∏–Ω—Å–∫–∏ –æ–ø–∏—Ç - –Ω—è–º–∞ –≥—Ä–µ—à–Ω–∏ –æ—Ç–≥–æ–≤–æ—Ä–∏, —Å–∞–º–æ –≤—ä–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∑–∞ —É—á–µ–Ω–µ!",
  "strengths": [],
  "improvements": ["–ü—Ä–æ—á–µ—Ç–∏ –∑–∞–¥–∞—á–∞—Ç–∞ –≤–Ω–∏–º–∞—Ç–µ–ª–Ω–æ", "–î–∞–π —Ä–µ–∞–ª–µ–Ω –æ–ø–∏—Ç –∑–∞ –æ—Ç–≥–æ–≤–æ—Ä"],
  "followUpQuestion": "–ö–∞–∫–≤–æ —Ä–∞–∑–±—Ä–∞ –æ—Ç –º–æ–¥—É–ª–∞, –∫–æ–µ—Ç–æ –º–æ–∂–µ—à –¥–∞ –ø—Ä–∏–ª–æ–∂–∏—à —Ç—É–∫?",
  "isInvalid": true
}

## STEAM-AI –ú–û–î–£–õ–ò (–ó–∞ —Ä–µ—Ñ–µ—Ä–µ–Ω—Ü–∏—è)

- Module 1 SCIENCE: AI –∏–∑—á–∏—Å–ª—è–≤–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏, –Ω–µ "–º–∏—Å–ª–∏". –ú–µ—Ö–∞–Ω–∏–∑—ä–º –Ω–∞ –í–Ω–∏–º–∞–Ω–∏–µ—Ç–æ = –¥–∏–Ω–∞–º–∏—á–Ω–æ –ø—Ä–µ—Ç–µ–≥–ª—è–Ω–µ. –•–∞–ª—é—Ü–∏–Ω–∞—Ü–∏–∏ = —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏ —Ñ–µ–Ω–æ–º–µ–Ω –ø—Ä–∏ –Ω–∏—Å–∫–∞ —É–≤–µ—Ä–µ–Ω–æ—Å—Ç.
- Module 2 TECHNOLOGY: –ú—É–ª—Ç–∏–º–æ–¥–∞–ª–Ω–∏ –º–æ–¥–µ–ª–∏. –ê–≥–µ–Ω—Ç–Ω–∏ —Å–∏—Å—Ç–µ–º–∏ vs. –í–µ—Ä–∏–∂–Ω–∏ –ü—Ä–æ–º–ø—Ç–æ–≤–µ. –†–ê–ì –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∑–∞ –∑–∞–∑–µ–º—è–≤–∞–Ω–µ.
- Module 3 ENGINEERING: –†-–ö-–ó-–û –†–∞–º–∫–∞ (–†–æ–ª—è, –ö–æ–Ω—Ç–µ–∫—Å—Ç, –ó–∞–¥–∞—á–∞, –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è). –¶–∏–∫—ä–ª –Ω–∞ –û—Ç—Ö–≤—ä—Ä–ª—è–Ω–µ. –ë–µ–∑ –ü—Ä–∏–º–µ—Ä–∏ vs –ù—è–∫–æ–ª–∫–æ –ü—Ä–∏–º–µ—Ä–∞.
- Module 4 ARTS: –ö—É—Ä–∞—Ç–æ—Ä > –ó–∞–Ω–∞—è—Ç—á–∏—è. –ß–æ–≤–µ–∫ –≤ –¶–∏–∫—ä–ª–∞. 30-—Å–µ–∫—É–Ω–¥–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ AI –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.
- Module 5 MINDSET: –í—Ä–µ–º–µ –¥–æ –°—Ç–æ–π–Ω–æ—Å—Ç. –ú–∞—Ç—Ä–∏—Ü–∞ –Ω–∞ –î–µ–ª–µ–≥–∏—Ä–∞–Ω–µ (–ù–∏–≤–æ 1-4). –°—ä—Å—Ç–µ–∑–∞—Ç–µ–ª–Ω–æ –ú–∏—Å–ª–µ–Ω–µ. –ü—Ä–µ–¥—Å–º—ä—Ä—Ç–µ–Ω –ê–Ω–∞–ª–∏–∑.
`

// PRACTICAL Challenges for each module
const CHALLENGES: Record<string, { task: string; criteria: string; hints: string[] }> = {
    science: {
        task: `üß™ –ü–†–ï–î–ò–ó–í–ò–ö–ê–¢–ï–õ–°–¢–í–û: –ù–∞–º–∞–ª—è–≤–∞–Ω–µ –Ω–∞ —Ö–∞–ª—é—Ü–∏–Ω–∞—Ü–∏–∏—Ç–µ

–ü—Ä–µ–¥—Å—Ç–∞–≤–∏ —Å–∏, —á–µ –∏–∑–ø–æ–ª–∑–≤–∞—à AI –∑–∞ –∏–∑—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—Å–∫–∞ –∑–∞–¥–∞—á–∞. –¢–≤–æ—è—Ç –∫–æ–ª–µ–≥–∞ —Ç–∏ –ø—Ä–∞—â–∞ —Å–ª–µ–¥–Ω–∏—è prompt:

"–ù–∞–ø–∏—à–∏ –º–∏ –≤—Å–∏—á–∫–æ –∑–∞ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞ –Ω–∞ –∫–≤–∞–Ω—Ç–æ–≤–∏—Ç–µ –∫–æ–º–ø—é—Ç—Ä–∏ –∏ –∫–æ–∏ —Å–∞ –≤–æ–¥–µ—â–∏—Ç–µ —É—á–µ–Ω–∏ –≤ —Ç–∞–∑–∏ –æ–±–ª–∞—Å—Ç."

–¢–æ–∑–∏ prompt –∏–º–∞ –í–ò–°–û–ö –†–ò–°–ö –æ—Ç —Ö–∞–ª—é—Ü–∏–Ω–∞—Ü–∏–∏.

üìã –¢–í–û–Ø–¢–ê –ó–ê–î–ê–ß–ê:
1. –û–±—è—Å–Ω–∏ –ó–ê–©–û —Ç–æ–∑–∏ prompt –µ —Ä–∏—Å–∫–æ–≤ (–∏–∑–ø–æ–ª–∑–≤–∞–π –∑–Ω–∞–Ω–∏—è—Ç–∞ –∑–∞ –ú–µ—Ö–∞–Ω–∏–∑—ä–º –Ω–∞ –í–Ω–∏–º–∞–Ω–∏–µ—Ç–æ –∏ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–Ω–∞—Ç–∞ –ø—Ä–∏—Ä–æ–¥–∞ –Ω–∞ AI)
2. –ü—Ä–µ–Ω–∞–ø–∏—à–∏ prompt-–∞ —Ç–∞–∫–∞, —á–µ –¥–∞ –ù–ê–ú–ê–õ–ò–® —Ä–∏—Å–∫–∞ –æ—Ç —Ö–∞–ª—é—Ü–∏–Ω–∞—Ü–∏–∏
3. –î–æ–±–∞–≤–∏ –ø–æ–Ω–µ –ï–î–ù–ê —Ç–µ—Ö–Ω–∏–∫–∞ –∑–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è, –∫–æ—è—Ç–æ –±–∏—Ö—Ç–µ –∏–∑–ø–æ–ª–∑–≤–∞–ª–∏ —Å–ª–µ–¥ –ø–æ–ª—É—á–∞–≤–∞–Ω–µ –Ω–∞ –æ—Ç–≥–æ–≤–æ—Ä–∞`,
        criteria: `–£—Å–ø–µ—à–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä —Ç—Ä—è–±–≤–∞ –¥–∞:
1. –û–±—è—Å–Ω–∏ –∑–∞—â–æ —à–∏—Ä–æ–∫–∏—Ç–µ, –æ—Ç–≤–æ—Ä–µ–Ω–∏ –≤—ä–ø—Ä–æ—Å–∏ –≤–æ–¥—è—Ç –¥–æ —Ö–∞–ª—é—Ü–∏–Ω–∞—Ü–∏–∏ (—Ä–∞–∑—Å–µ–π–≤–∞–Ω–µ –Ω–∞ –≤–Ω–∏–º–∞–Ω–∏–µ—Ç–æ, –Ω–∏—Å–∫–∞ —É–≤–µ—Ä–µ–Ω–æ—Å—Ç –≤ —Ä–µ–¥–∫–∏ —Ñ–∞–∫—Ç–∏)
2. –ü—Ä–µ–¥–ª–æ–∂–∏ –ø–æ-–∫–æ–Ω–∫—Ä–µ—Ç–µ–Ω prompt —Å —è—Å–Ω–∏ –≥—Ä–∞–Ω–∏—Ü–∏ (–ø–µ—Ä–∏–æ–¥, –±—Ä–æ–π —É—á–µ–Ω–∏, –∏–∑—Ç–æ—á–Ω–∏–∫)
3. –°–ø–æ–º–µ–Ω–µ—Ç–µ –ø–æ–Ω–µ –µ–¥–Ω–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–æ–Ω–Ω–∞ —Ç–µ—Ö–Ω–∏–∫–∞ (–∫—Ä—ä—Å—Ç–æ—Å–∞–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞, –∏—Å–∫–∞–Ω–µ –Ω–∞ –∏–∑—Ç–æ—á–Ω–∏—Ü–∏, —Ä–∞–∑–±–∏–≤–∞–Ω–µ –Ω–∞ –≤—ä–ø—Ä–æ—Å–∞)`,
        hints: [
            '–ü–æ–º–∏—Å–ª–∏ –∫–∞–∫–≤–æ –∑–Ω–∞–µ—à –∑–∞ "–ø—Ä–æ–∂–µ–∫—Ç–æ—Ä–∞ –Ω–∞ –≤–Ω–∏–º–∞–Ω–∏–µ—Ç–æ" - –∫–∞–∫–≤–æ —Å—Ç–∞–≤–∞ –∫–æ–≥–∞—Ç–æ –µ —Ç–≤—ä—Ä–¥–µ —à–∏—Ä–æ–∫?',
            '–ö–∞–∫ –º–æ–∂–µ—à –¥–∞ "–∑–∞–∑–µ–º–∏—à" AI-—Ç–æ –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏ —Ñ–∞–∫—Ç–∏?',
            '–í–µ—Ä–∏–≥–∞ –Ω–∞ –ú–∏—Å—ä–ª—Ç–∞ –º–æ–∂–µ –¥–∞ –ø–æ–º–æ–≥–Ω–µ - –∫–∞–∫?'
        ]
    },
    technology: {
        task: `üîß –ü–†–ï–î–ò–ó–í–ò–ö–ê–¢–ï–õ–°–¢–í–û: –ú—É–ª—Ç–∏–º–æ–¥–∞–ª–µ–Ω Workflow

–¢–∏ —Å–∏ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥ –º–µ–Ω–∏–¥–∂—ä—Ä –≤ –º–∞–ª–∫–∞ –∫–æ–º–ø–∞–Ω–∏—è –∑–∞ –æ—Ä–≥–∞–Ω–∏—á–Ω–∞ –∫–æ–∑–º–µ—Ç–∏–∫–∞. –¢—Ä—è–±–≤–∞ –¥–∞ —Å—ä–∑–¥–∞–¥–µ—à –ø—ä–ª–Ω–∞ —Ä–µ–∫–ª–∞–º–Ω–∞ –∫–∞–º–ø–∞–Ω–∏—è –∑–∞ –Ω–æ–≤ –∫—Ä–µ–º –∑–∞ –ª–∏—Ü–µ.

üìã –¢–í–û–Ø–¢–ê –ó–ê–î–ê–ß–ê:
–°—ä–∑–¥–∞–π 4-—Å—Ç—ä–ø–∫–æ–≤ AI workflow, –∫–æ–π—Ç–æ:
1. –ò–∑–ø–æ–ª–∑–≤–∞ –ú–ò–ù–ò–ú–£–ú 2 —Ç–∏–ø–∞ –º–æ–¥–∞–ª–Ω–æ—Å—Ç (—Ç–µ–∫—Å—Ç, –≤–∏–∑–∏—è, –∞—É–¥–∏–æ)
2. –ó–∞ –≤—Å—è–∫–∞ —Å—Ç—ä–ø–∫–∞ –ø–æ—Å–æ—á–∏:
   - –ö–æ–π AI –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–µ –∏–∑–ø–æ–ª–∑–≤–∞
   - –ö–∞–∫—ä–≤ input –ø–æ–ª—É—á–∞–≤–∞
   - –ö–∞–∫—ä–≤ output –¥–∞–≤–∞
3. –ü–æ–∫–∞–∂–∏ –∫–∞–∫ output-—ä—Ç –æ—Ç –µ–¥–Ω–∞ —Å—Ç—ä–ø–∫–∞ —Å—Ç–∞–≤–∞ input –∑–∞ —Å–ª–µ–¥–≤–∞—â–∞—Ç–∞

–ë–æ–Ω—É—Å: –ö—ä–¥–µ –±–∏ –≤–∫–ª—é—á–∏–ª "–ß–æ–≤–µ–∫ –≤ –¶–∏–∫—ä–ª–∞" –ø—Ä–æ–≤–µ—Ä–∫–∞?`,
        criteria: `–£—Å–ø–µ—à–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä —Ç—Ä—è–±–≤–∞ –¥–∞:
1. –ò–∑–±—Ä–æ–∏ 4 –ª–æ–≥–∏—á–Ω–∏, —Å–≤—ä—Ä–∑–∞–Ω–∏ —Å—Ç—ä–ø–∫–∏
2. –ò–∑–ø–æ–ª–∑–≤–∞ –ø–æ–Ω–µ 2 –º–æ–¥–∞–ª–Ω–æ—Å—Ç–∏ (–Ω–∞–ø—Ä. ChatGPT –∑–∞ —Ç–µ–∫—Å—Ç + Midjourney/DALL-E –∑–∞ –≤–∏–∑–∏—è + ElevenLabs –∑–∞ –∞—É–¥–∏–æ)
3. –ü–æ–∫–∞–∂–µ —è—Å–Ω–∞ –≤—Ä—ä–∑–∫–∞ –º–µ–∂–¥—É —Å—Ç—ä–ø–∫–∏—Ç–µ (output ‚Üí input)
4. –ë–æ–Ω—É—Å: –ò–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–∞ –∫—ä–¥–µ –µ –Ω—É–∂–Ω–∞ —á–æ–≤–µ—à–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞`,
        hints: [
            '–ü–æ–º–∏—Å–ª–∏ –∑–∞ –ø—ä–ª–Ω–∏—è –ø—ä—Ç: –∏–¥–µ—è ‚Üí —Ç–µ–∫—Å—Ç ‚Üí –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è ‚Üí —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è',
            '–ö–æ–∏ —á–∞—Å—Ç–∏ –∏–∑–∏—Å–∫–≤–∞—Ç —Ç–≤–æ—Ä—á–µ—Å–∫–∏ –∫–æ–Ω—Ç—Ä–æ–ª –æ—Ç —á–æ–≤–µ–∫?',
            '–ö–∞–∫ –±–∏ –∏–∑–ø–æ–ª–∑–≤–∞–ª —Ç–µ–∫—Å—Ç–æ–≤ AI –∑–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ prompt –∑–∞ –≤–∏–∑—É–∞–ª–µ–Ω AI?'
        ]
    },
    engineering: {
        task: `‚öôÔ∏è –ü–†–ï–î–ò–ó–í–ò–ö–ê–¢–ï–õ–°–¢–í–û: –†-–ö-–ó-–û –≤ –î–µ–π—Å—Ç–≤–∏–µ

–°–∏—Ç—É–∞—Ü–∏—è: –¢–∏ —Å–∏ HR –º–µ–Ω–∏–¥–∂—ä—Ä. –°–ª—É–∂–∏—Ç–µ–ª –µ –ø–æ–∏—Å–∫–∞–ª –ø–æ–≤–∏—à–µ–Ω–∏–µ, –Ω–æ –ø—Ä–µ–¥—Å—Ç–∞–≤—è–Ω–µ—Ç–æ –º—É –µ –±–∏–ª–æ —Å—Ä–µ–¥–Ω–æ. –¢—Ä—è–±–≤–∞ –¥–∞ –Ω–∞–ø–∏—à–µ—à —Ç–∞–∫—Ç–∏—á–µ–Ω –∏–º–µ–π–ª, –∫–æ–π—Ç–æ –æ—Ç–∫–∞–∑–≤–∞ –∑–∞ –º–æ–º–µ–Ω—Ç–∞, –Ω–æ –º–æ—Ç–∏–≤–∏—Ä–∞ –∑–∞ –±—ä–¥–µ—â–æ —Ä–∞–∑–≤–∏—Ç–∏–µ.

üìã –¢–í–û–Ø–¢–ê –ó–ê–î–ê–ß–ê:
–ù–∞–ø–∏—à–∏ –ü–™–õ–ï–ù prompt –∑–∞ ChatGPT, –∏–∑–ø–æ–ª–∑–≤–∞–π–∫–∏ –†-–ö-–ó-–û —Ä–∞–º–∫–∞—Ç–∞:
- –†–æ–ª—è: –ö–æ–π –µ AI-—Ç–æ –≤ —Ç–æ–∑–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç?
- –ö–æ–Ω—Ç–µ–∫—Å—Ç: –ö–∞–∫–≤–∞ –µ —Å–∏—Ç—É–∞—Ü–∏—è—Ç–∞? (–±—ä–¥–∏ –∫–æ–Ω–∫—Ä–µ—Ç–µ–Ω)
- –ó–∞–¥–∞—á–∞: –ö–∞–∫–≤–æ —Ç–æ—á–Ω–æ —Ç—Ä—è–±–≤–∞ –¥–∞ –Ω–∞–ø—Ä–∞–≤–∏? (–∞–∫—Ç–∏–≤–µ–Ω –≥–ª–∞–≥–æ–ª)
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è: –ö–∞–∫–≤–∏ —Å–∞ –≥—Ä–∞–Ω–∏—Ü–∏—Ç–µ? (–¥—ä–ª–∂–∏–Ω–∞, —Ç–æ–Ω, –∫–∞–∫–≤–æ –¥–∞ –∏–∑–±—è–≥–≤–∞)

Prompt-—ä—Ç —Ç—Ä—è–±–≤–∞ –¥–∞ –µ –≥–æ—Ç–æ–≤ –∑–∞ –¥–∏—Ä–µ–∫—Ç–Ω–æ –∫–æ–ø–∏—Ä–∞–Ω–µ –≤ ChatGPT.`,
        criteria: `–£—Å–ø–µ—à–µ–Ω prompt —Ç—Ä—è–±–≤–∞ –¥–∞ —Å—ä–¥—ä—Ä–∂–∞:
1. –Ø—Å–Ω–∞ –†–æ–ª—è (–Ω–∞–ø—Ä. "–¢–∏ —Å–∏ –æ–ø–∏—Ç–µ–Ω HR —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç —Å 15 –≥–æ–¥–∏–Ω–∏ –æ–ø–∏—Ç...")
2. –°–ø–µ—Ü–∏—Ñ–∏—á–µ–Ω –ö–æ–Ω—Ç–µ–∫—Å—Ç (–Ω–∞–ø—Ä. "–°–ª—É–∂–∏—Ç–µ–ª—è—Ç –µ –≤ –∫–æ–º–ø–∞–Ω–∏—è—Ç–∞ 3 –≥–æ–¥–∏–Ω–∏, –∏–º–∞—à–µ 2 –ø—Ä–æ–ø—É—Å–Ω–∞—Ç–∏ –¥–µ–¥–ª–∞–π–Ω–∞...")
3. –ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞ –ó–∞–¥–∞—á–∞ —Å –∞–∫—Ç–∏–≤–µ–Ω –≥–ª–∞–≥–æ–ª (–Ω–∞–ø—Ä. "–ù–∞–ø–∏—à–∏ –∏–º–µ–π–ª, –∫–æ–π—Ç–æ...")
4. –ü–æ–Ω–µ 3 –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è (–¥—ä–ª–∂–∏–Ω–∞, —Ç–æ–Ω, –∫–∞–∫–≤–æ –¥–∞ –≤–∫–ª—é—á–∏/–∏–∑–±–µ–≥–Ω–µ)`,
        hints: [
            '–†–æ–ª—è—Ç–∞ –∞–∫—Ç–∏–≤–∏—Ä–∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–∏ "–∑–Ω–∞–Ω–∏—è" –≤ AI-—Ç–æ - –±—ä–¥–∏ –∫–æ–Ω–∫—Ä–µ—Ç–µ–Ω!',
            '–ö–æ–Ω—Ç–µ–∫—Å—Ç—ä—Ç –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç—è–≤–∞ —Ö–∞–ª—é—Ü–∏–Ω–∞—Ü–∏–∏ - –¥–∞–π –¥–µ—Ç–∞–π–ª–∏',
            '–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è—Ç–∞ —Å–∞ –ø–æ-–≤–∞–∂–Ω–∏ –æ—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏—Ç–µ - –∫–∞–∫–≤–æ –ù–ï –∏—Å–∫–∞—à?'
        ]
    },
    arts: {
        task: `üé® –ü–†–ï–î–ò–ó–í–ò–ö–ê–¢–ï–õ–°–¢–í–û: –û–∫–æ—Ç–æ –Ω–∞ –ö—É—Ä–∞—Ç–æ—Ä–∞

–¢–∏ —Å–∏ –∫—Ä–µ–∞—Ç–∏–≤–µ–Ω –¥–∏—Ä–µ–∫—Ç–æ—Ä –∑–∞ –ª—É–∫—Å–æ–∑–Ω–∞ –º–∞—Ä–∫–∞ —á–∞—Å–æ–≤–Ω–∏—Ü–∏. AI –µ –≥–µ–Ω–µ—Ä–∏—Ä–∞–ª 3 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞ –Ω–æ–≤–∞—Ç–∞ –∫–∞–º–ø–∞–Ω–∏—è:

**–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ A:** –§–æ—Ç–æ—Ä–µ–∞–ª–∏—Å—Ç–∏—á–µ–Ω —á–∞—Å–æ–≤–Ω–∏–∫ –≤—ä—Ä—Ö—É —á–µ—Ä–µ–Ω –º—Ä–∞–º–æ—Ä, –¥—Ä–∞–º–∞—Ç–∏—á–Ω–æ —Å—Ç—Ä–∞–Ω–∏—á–Ω–æ –æ—Å–≤–µ—Ç–ª–µ–Ω–∏–µ, –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–µ–Ω
**–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ B:** –ê–±—Å—Ç—Ä–∞–∫—Ç–Ω–∞ –∫–æ–º–ø–æ–∑–∏—Ü–∏—è - —á–∞—Å–æ–≤–Ω–∏–∫–æ–≤–∏ –º–µ—Ö–∞–Ω–∏–∑–º–∏ "—Ç–∞–Ω—Ü—É–≤–∞—Ç" –≤ –∑–ª–∞—Ç–Ω–æ –∏ —Å–∏–Ω—å–æ, –∞—Ä—Ç–∏—Å—Ç–∏—á–µ–Ω –∏ –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–µ–Ω
**–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ C:** –ß–∞—Å–æ–≤–Ω–∏–∫ –Ω–∞ –∫–∏—Ç–∫–∞—Ç–∞ –Ω–∞ –µ–ª–µ–≥–∞–Ω—Ç–µ–Ω –º—ä–∂ –Ω–∞ —è—Ö—Ç–∞, –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–∞ —Å–≤–µ—Ç–ª–∏–Ω–∞, lifestyle

üìã –¢–í–û–Ø–¢–ê –ó–ê–î–ê–ß–ê:
1. –ò–∑–±–µ—Ä–∏ –ï–î–ù–û –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞ —Ñ–∏–Ω–∞–ª–Ω–∞—Ç–∞ –∫–∞–º–ø–∞–Ω–∏—è
2. –û–±–æ—Å–Ω–æ–≤–∏ –∏–∑–±–æ—Ä–∞ —Å–∏, –∏–∑–ø–æ–ª–∑–≤–∞–π–∫–∏ –¢–†–ò–¢–ï –∫—É—Ä–∞—Ç–æ—Ä—Å–∫–∏ –∫—Ä–∏—Ç–µ—Ä–∏—è:
   - –°—ä–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å –ë—Ä–∞–Ω–¥–∞
   - –ï–º–æ—Ü–∏–æ–Ω–∞–ª–µ–Ω –†–µ–∑–æ–Ω–∞–Ω—Å
   - –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞ –¶—è–ª–æ—Å—Ç
3. –û–±—è—Å–Ω–∏ –∑–∞—â–æ –æ—Ç—Ö–≤—ä—Ä–ª—è—à –¥—Ä—É–≥–∏—Ç–µ –¥–≤–µ`,
        criteria: `–£—Å–ø–µ—à–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä —Ç—Ä—è–±–≤–∞ –¥–∞:
1. –ù–∞–ø—Ä–∞–≤–∏ —è—Å–µ–Ω –∏–∑–±–æ—Ä —Å —É–≤–µ—Ä–µ–Ω–æ—Å—Ç
2. –ò–∑–ø–æ–ª–∑–≤–∞ –∏ —Ç—Ä–∏—Ç–µ –∫—Ä–∏—Ç–µ—Ä–∏—è –∑–∞ –æ–±–æ—Å–Ω–æ–≤–∫–∞
3. –î–∞–¥–µ –ª–æ–≥–∏—á–Ω–æ –æ–±—è—Å–Ω–µ–Ω–∏–µ –∑–∞—â–æ –∏–∑–±—Ä–∞–Ω–æ—Ç–æ —Å—ä–æ—Ç–≤–µ—Ç—Å—Ç–≤–∞ –Ω–∞ "–ª—É–∫—Å–æ–∑–µ–Ω" –±—Ä–∞–Ω–¥
4. –ü–æ–∫–∞–∂–µ —Ä–∞–∑–±–∏—Ä–∞–Ω–µ –∑–∞—â–æ –¥—Ä—É–≥–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç–∏ –Ω–µ —Å–∞ –ø–æ–¥—Ö–æ–¥—è—â–∏`,
        hints: [
            '–õ—É–∫—Å–æ–∑–Ω–∏—è—Ç –±—Ä–∞–Ω–¥ —Ü–µ–Ω–∏ –∫–∞–∫–≤–æ? –¢—Ä–∞–¥–∏—Ü–∏—è, –∫–∞—á–µ—Å—Ç–≤–æ, —Å—Ç–∞—Ç—É—Å...',
            '–ü–æ–º–∏—Å–ª–∏ –∑–∞ —Ü–µ–ª–µ–≤–∞—Ç–∞ –∞—É–¥–∏—Ç–æ—Ä–∏—è - –∫–∞–∫–≤–æ –∏—Å–∫–∞—Ç –¥–∞ –ø–æ—á—É–≤—Å—Ç–≤–∞—Ç?',
            '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞ —Ü—è–ª–æ—Å—Ç ‚â† —Å–∞–º–æ "—Ö—É–±–∞–≤–æ" - –∏–º–∞ –ª–∏ –ª–æ–≥–∏—á–µ—Å–∫–∏ –≥—Ä–µ—à–∫–∏?'
        ]
    },
    mindset: {
        task: `üß† –ü–†–ï–î–ò–ó–í–ò–ö–ê–¢–ï–õ–°–¢–í–û: –ú–∞—Ç—Ä–∏—Ü–∞—Ç–∞ –Ω–∞ –î–µ–ª–µ–≥–∏—Ä–∞–Ω–µ

–ü—Ä–µ–¥—Å—Ç–∞–≤–∏ —Å–∏, —á–µ —É–ø—Ä–∞–≤–ª—è–≤–∞—à –º–∞—Ä–∫–µ—Ç–∏–Ω–≥ –µ–∫–∏–ø –æ—Ç 5 —á–æ–≤–µ–∫–∞. –ï—Ç–æ –∑–∞–¥–∞—á–∏—Ç–µ –∑–∞ —Ç–∞–∑–∏ —Å–µ–¥–º–∏—Ü–∞:

1. –ü–∏—Å–∞–Ω–µ –Ω–∞ —Å–µ–¥–º–∏—á–µ–Ω newsletter (—Ä–µ–¥–∞–∫—Ü–∏–æ–Ω–µ–Ω —Ñ–æ—Ä–º–∞—Ç, —Ñ–∏—Ä–º–µ–Ω –≥–ª–∞—Å)
2. –°—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏ –ø–ª–∞–Ω –∑–∞ –Ω–∞–≤–ª–∏–∑–∞–Ω–µ –Ω–∞ –Ω–æ–≤ –ø–∞–∑–∞—Ä
3. –ö–ª–∞—Å–∏—Ñ–∏—Ü–∏—Ä–∞–Ω–µ –Ω–∞ 1000 –∫–ª–∏–µ–Ω—Ç—Å–∫–∏ –æ—Ç–∑–∏–≤–∞ –ø–æ —Ç–µ–º–∞ –∏ —Ç–æ–Ω
4. –ü—Ä–æ–≤–µ–∂–¥–∞–Ω–µ –Ω–∞ –ø—Ä–µ–≥–æ–≤–æ—Ä–∏ —Å –∫–ª—é—á–æ–≤ –ø–∞—Ä—Ç–Ω—å–æ—Ä
5. –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ 20 –∏–¥–µ–∏ –∑–∞ —Å–æ—Ü–∏–∞–ª–Ω–∏ –ø–æ—Å—Ç–æ–≤–µ

üìã –¢–í–û–Ø–¢–ê –ó–ê–î–ê–ß–ê:
–ö–ª–∞—Å–∏—Ñ–∏—Ü–∏—Ä–∞–π –í–°–Ø–ö–ê –∑–∞–¥–∞—á–∞ –≤ –ú–∞—Ç—Ä–∏—Ü–∞—Ç–∞ –Ω–∞ –î–µ–ª–µ–≥–∏—Ä–∞–Ω–µ:
- –ù–∏–≤–æ 1: –ë–µ–∑ AI (–ß–æ–≤–µ–∫ –ø—Ä–∞–≤–∏ –≤—Å–∏—á–∫–æ)
- –ù–∏–≤–æ 2: –ü—Ä–µ–¥–ø–∏—Å–∞–Ω–∞ –ê–≥–µ–Ω—Ç–Ω–æ—Å—Ç (AI —Å–ª–µ–¥–≤–∞ —Å—Ç—Ä–æ–≥ —Å–∫—Ä–∏–ø—Ç)
- –ù–∏–≤–æ 3: –ù–∞–±–ª—é–¥–∞–≤–∞–Ω–∞ –ê–≥–µ–Ω—Ç–Ω–æ—Å—Ç (AI + —á–æ–≤–µ—à–∫–æ –æ–¥–æ–±—Ä–µ–Ω–∏–µ)
- –ù–∏–≤–æ 4: –ü—ä–ª–Ω–∞ –ê–≤—Ç–æ–Ω–æ–º–∏—è (AI –∞–≤—Ç–æ–Ω–æ–º–Ω–æ)

–ó–∞ –í–°–Ø–ö–ê –∑–∞–¥–∞—á–∞ –æ–±—è—Å–Ω–∏ –Ω–∞–∫—Ä–∞—Ç–∫–æ –ó–ê–©–û —è –∫–ª–∞—Å–∏—Ñ–∏—Ü–∏—Ä–∞—à —Ç–∞–∫–∞.`,
        criteria: `–û—á–∞–∫–≤–∞–Ω–∏ –∫–ª–∞—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–Ω–æ –≤–∞–∂–Ω–æ—Ç–æ –µ –ª–æ–≥–∏–∫–∞—Ç–∞):
1. Newsletter = –ù–∏–≤–æ 3 (AI –ø–∏—à–µ —á–µ—Ä–Ω–æ–≤–∞, —á–æ–≤–µ–∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–∞ –∑–∞ —Ç–æ–Ω)
2. –°—Ç—Ä–∞—Ç–µ–≥–∏—è = –ù–∏–≤–æ 1 (–∏–∑–∏—Å–∫–≤–∞ —á–æ–≤–µ—à–∫–∞ –ø—Ä–µ—Ü–µ–Ω–∫–∞ –∏ –æ—Ç–≥–æ–≤–æ—Ä–Ω–æ—Å—Ç)
3. –ö–ª–∞—Å–∏—Ñ–∏–∫–∞—Ü–∏—è = –ù–∏–≤–æ 2 –∏–ª–∏ 4 (—Ä—É—Ç–∏–Ω–Ω–∞ –∑–∞–¥–∞—á–∞, —è—Å–Ω–∏ –ø—Ä–∞–≤–∏–ª–∞)
4. –ü—Ä–µ–≥–æ–≤–æ—Ä–∏ = –ù–∏–≤–æ 1 (–∏–∑–∏—Å–∫–≤–∞ –µ–º–æ—Ü–∏–æ–Ω–∞–ª–Ω–∞ –∏–Ω—Ç–µ–ª–∏–≥–µ–Ω—Ç–Ω–æ—Å—Ç)
5. –ò–¥–µ–∏ = –ù–∏–≤–æ 3 (AI –≥–µ–Ω–µ—Ä–∏—Ä–∞, —á–æ–≤–µ–∫ –∏–∑–±–∏—Ä–∞)

–õ–æ–≥–∏—á–Ω–æ—Ç–æ –æ–±—è—Å–Ω–µ–Ω–∏–µ –µ –ø–æ-–≤–∞–∂–Ω–æ –æ—Ç "–ø—Ä–∞–≤–∏–ª–Ω–∏—è" –æ—Ç–≥–æ–≤–æ—Ä!`,
        hints: [
            '–ö–æ–∏ –∑–∞–¥–∞—á–∏ –∏–∑–∏—Å–∫–≤–∞—Ç –ï–ú–û–¶–ò–û–ù–ê–õ–ù–ê –∏–Ω—Ç–µ–ª–∏–≥–µ–Ω—Ç–Ω–æ—Å—Ç?',
            '–ö–æ–∏ —Å–∞ —Ä—É—Ç–∏–Ω–Ω–∏ –∏ —Å —è—Å–Ω–∏ –ø—Ä–∞–≤–∏–ª–∞?',
            '–ö—ä–¥–µ –±–∏ –ø–æ–µ–ª –æ—Ç–≥–æ–≤–æ—Ä–Ω–æ—Å—Ç –∞–∫–æ –Ω–µ—â–æ —Å–µ –æ–±—ä—Ä–∫–∞?'
        ]
    }
}

// GET handler for debugging
export async function GET() {
    const hasKey = !!process.env.GEMINI_API_KEY
    const keyPreview = hasKey ? process.env.GEMINI_API_KEY?.slice(0, 10) + '...' : 'NOT SET'
    return Response.json({
        status: 'AI Mentor API is running',
        geminiKeyConfigured: hasKey,
        keyPreview: keyPreview,
        availableChallenges: Object.keys(CHALLENGES)
    })
}

export async function POST(request: NextRequest) {
    try {
        const { moduleId, userResponse, action } = await request.json()

        console.log('AI Mentor API called:', { moduleId, action })

        // Get challenge - doesn't require AI
        if (action === 'getChallenge') {
            const challenge = CHALLENGES[moduleId]
            if (!challenge) {
                console.log('Challenge not found for module:', moduleId)
                return NextResponse.json({ error: 'Challenge not found', moduleId }, { status: 404 })
            }
            console.log('Returning challenge for:', moduleId)
            return NextResponse.json({ challenge: challenge.task })
        }

        // For evaluate action, we need the API key
        if (!process.env.GEMINI_API_KEY) {
            console.error('GEMINI_API_KEY not configured')
            return NextResponse.json({ error: 'API key not configured' }, { status: 500 })
        }

        const model = genAI.getGenerativeModel({ model: 'gemini-2.0-flash-exp' })

        // Evaluate user response
        if (action === 'evaluate') {
            const challenge = CHALLENGES[moduleId]
            if (!challenge) {
                return NextResponse.json({ error: 'Challenge not found' }, { status: 404 })
            }

            const evaluationPrompt = `${MENTOR_CONTEXT}

–¢–ï–ö–£–©–ê –ó–ê–î–ê–ß–ê –ó–ê –û–¶–ï–ù–ö–ê:
${challenge.task}

–ö–†–ò–¢–ï–†–ò–ò –ó–ê –£–°–ü–ï–•:
${challenge.criteria}

–ù–ê–õ–ò–ß–ù–ò –ü–û–î–°–ö–ê–ó–ö–ò (–∏–Ω—Ç–µ–≥—Ä–∏—Ä–∞–π –≤ feedback-–∞ —Å–∞–º–æ –∞–∫–æ score < 70):
${challenge.hints.map((h, i) => `${i + 1}. ${h}`).join('\n')}

–û–¢–ì–û–í–û–† –ù–ê –£–ß–ï–ù–ò–ö–ê:
"""
${userResponse}
"""

–ò–ù–°–¢–†–£–ö–¶–ò–ò:

1. –ü–™–†–í–û –ø—Ä–æ–≤–µ—Ä–∏ –∑–∞ –Ω–µ–≤–∞–ª–∏–¥–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä (trolling, spam, < 20 —Å–∏–º–≤–æ–ª–∞, copy-paste –Ω–∞ –∑–∞–¥–∞–Ω–∏–µ—Ç–æ)
2. –ê–∫–æ –µ –Ω–µ–≤–∞–ª–∏–¥–µ–Ω, –∏–∑–ø–æ–ª–∑–≤–∞–π failsafe –æ—Ç–≥–æ–≤–æ—Ä–∞ –æ—Ç —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞
3. –ò–Ω–∞—á–µ –æ—Ü–µ–Ω–∏ –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏–∏—Ç–µ –∏ –∞–¥–∞–ø—Ç–∏—Ä–∞–π feedback-–∞

–í–™–†–ù–ò –°–ê–ú–û –í–ê–õ–ò–î–ï–ù JSON:
{
  "passed": boolean (true –°–ê–ú–û –∞–∫–æ score >= 70),
  "score": 0-100,
  "feedback": "–ê–¥–∞–ø—Ç–∏–≤–µ–Ω feedback –Ω–∞ –±—ä–ª–≥–∞—Ä—Å–∫–∏ —Å –µ–º–æ–¥–∂–∏",
  "strengths": ["–ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞ —Å–∏–ª–Ω–∞ —Å—Ç—Ä–∞–Ω–∞ 1", "–ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞ —Å–∏–ª–Ω–∞ —Å—Ç—Ä–∞–Ω–∞ 2"],
  "improvements": ["–ö–∞–∫–≤–æ –º–æ–∂–µ –¥–∞ —Å–µ –ø–æ–¥–æ–±—Ä–∏"],
  "followUpQuestion": "–ù–∞—Å–æ—á–≤–∞—â –≤—ä–ø—Ä–æ—Å –∞–∫–æ score < 70 (–∏–ª–∏ null)",
  "hint": "–ï–¥–Ω–∞ –ø–æ–¥—Å–∫–∞–∑–∫–∞ –∞–∫–æ score < 50 (–∏–ª–∏ null)",
  "isInvalid": boolean
}

–í–ê–ñ–ù–û: –í—ä—Ä–Ω–∏ –°–ê–ú–û JSON, –±–µ–∑ markdown!`

            const result = await model.generateContent(evaluationPrompt)
            const responseText = result.response.text()

            console.log('Gemini raw response:', responseText.slice(0, 500))

            // Parse JSON from response
            try {
                const cleanJson = responseText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim()
                console.log('Cleaned JSON:', cleanJson.slice(0, 300))
                const evaluation = JSON.parse(cleanJson)

                // Ensure all fields have valid defaults
                return NextResponse.json({
                    passed: evaluation.passed ?? false,
                    score: evaluation.score ?? 0,
                    feedback: evaluation.feedback ?? '–ù–µ –º–æ–∂–∞—Ö –¥–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞–º feedback. –û–ø–∏—Ç–∞–π –æ—Ç–Ω–æ–≤–æ.',
                    strengths: evaluation.strengths ?? [],
                    improvements: evaluation.improvements ?? [],
                    followUpQuestion: evaluation.followUpQuestion ?? null,
                    hint: evaluation.hint ?? null,
                    isInvalid: evaluation.isInvalid ?? false,
                    moduleId
                })
            } catch (parseError) {
                console.error('JSON parse error:', parseError)
                console.error('Raw response was:', responseText)
                // If JSON parsing fails, return with the raw text as feedback
                return NextResponse.json({
                    passed: false,
                    score: 30,
                    feedback: 'AI-—Ç–æ –Ω–µ —É—Å–ø—è –¥–∞ –≤—ä—Ä–Ω–µ –ø—Ä–∞–≤–∏–ª–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä. –ï—Ç–æ –∫–∞–∫–≤–æ –∫–∞–∑–∞: ' + responseText.slice(0, 300),
                    strengths: [],
                    improvements: ['–û–ø–∏—Ç–∞–π –æ—Ç–Ω–æ–≤–æ'],
                    followUpQuestion: null,
                    hint: null,
                    isInvalid: false,
                    moduleId
                })
            }
        }

        return NextResponse.json({ error: 'Invalid action' }, { status: 400 })

    } catch (error) {
        console.error('AI Mentor error:', error)
        return NextResponse.json({
            error: 'Failed to process request',
            details: error instanceof Error ? error.message : 'Unknown error'
        }, { status: 500 })
    }
}
